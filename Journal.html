<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Journal - Dark Mode</title>

<style>
body { font-family: Arial, sans-serif; margin: 0; background:#121212; color:white; }
#layout { display:flex; max-width:1100px; margin:auto; padding:20px; gap:20px; }
#app { flex:3; }
#sidebar { flex:1; background:#1e1e1e; padding:15px; border-radius:8px; height:fit-content; }

.post-box, .search-box { background:#1e1e1e; padding:15px; border-radius:8px; margin-bottom:20px; }
.post { background:#1e1e1e; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #333; }
.post img { max-width:100%; margin-top:10px; border-radius:6px; }

.hashtag { color:#4da3ff; cursor:pointer; }
.tag { display:block; margin-bottom:6px; cursor:pointer; color:#4da3ff; }

input, textarea { background:#2b2b2b; color:white; border:1px solid #444; }
button { background:#333; color:white; border:1px solid #555; padding:8px 12px; margin-right:6px; cursor:pointer; }

#previewImg { max-width:200px; margin-top:10px; border-radius:6px; display:none; border:1px solid #444; }
</style>
</head>

<body>
<div id="layout">

<!-- MAIN APP -->
<div id="app">

  <!-- SEARCH -->
  <div class="search-box">
    <input id="searchInput" type="text" placeholder="Search..." style="width:100%; padding:10px; font-size:16px;">
  </div>

  <!-- CREATE POST -->
  <div class="post-box">
    <textarea id="postText" placeholder="Write something..." style="width:100%; height:80px; padding:10px;"></textarea>

    <input id="imageInput" type="file" accept="image/*" style="margin-top:10px;">
    <img id="previewImg">

    <div>
      <button onclick="savePost()">Post</button>
    </div>
  </div>

  <div id="posts"></div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <h3>Hashtags</h3>
  <div id="tagList"></div>

  <h3>Recycle Bin</h3>
  <div id="deletedList"></div>
</div>

</div>

<script>
let posts = JSON.parse(localStorage.getItem("journal_posts") || "[]");
let deleted = JSON.parse(localStorage.getItem("journal_deleted") || "[]");
let editID = null;

// ---------- SAVE ----------
function saveAll() {
  localStorage.setItem("journal_posts", JSON.stringify(posts));
  localStorage.setItem("journal_deleted", JSON.stringify(deleted));
  renderTags();
  renderDeleted();
}

// ---------- HASHTAGS ----------
function extractHashtags(text) {
  let m = text.match(/#\w+/g);
  return m ? m.map(x => x.substring(1)) : [];
}

// ---------- IMAGE PREVIEW (PASTE) ----------
document.addEventListener("paste", (e) => {
  for (let item of e.clipboardData.items) {
    if (item.type.indexOf("image") !== -1) {
      let file = item.getAsFile();
      let reader = new FileReader();
      reader.onload = function(ev) {
        let img = document.getElementById("previewImg");
        img.src = ev.target.result;
        img.style.display = "block";
        document.getElementById("imageInput").dataset.pasted = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  }
});

// ---------- CREATE/UPDATE POST ----------
function savePost() {
  let text = document.getElementById("postText").value;
  let fileInput = document.getElementById("imageInput");
  let file = fileInput.files[0];
  let pasted = fileInput.dataset.pasted || null;

  if (!text.trim() && !file && !pasted) return;

  function finish(imageData) {
    if (editID) {
      let p = posts.find(x => x.id === editID);
      p.text = text;
      p.image = imageData;
      p.hashtags = extractHashtags(text);
      editID = null;
    } else {
      posts.unshift({
        id: Date.now(),
        text,
        image: imageData,
        hashtags: extractHashtags(text),
        created_at: new Date().toLocaleString()
      });
    }

    saveAll();
    renderPosts(posts);

    document.getElementById("postText").value = "";
    fileInput.value = "";
    delete fileInput.dataset.pasted;

    let pv = document.getElementById("previewImg");
    pv.style.display = "none";
    pv.src = "";
  }

  if (file) {
    let reader = new FileReader();
    reader.onload = e => finish(e.target.result);
    reader.readAsDataURL(file);
  } else {
    finish(pasted);
  }
}

// ---------- RENDER POSTS ----------
function renderPosts(list) {
  let box = document.getElementById("posts");
  box.innerHTML = "";

  list.forEach(p => {
    let div = document.createElement("div");
    div.className = "post";

    let txt = p.text.replace(/#(\w+)/g,
      "<span class='hashtag' onclick='filterHashtag(\"$1\")'>#$1</span>"
    );

    let html = "";
    html += "<div style='opacity:0.6;font-size:12px;'>" + p.created_at + "</div>";
    html += "<div>" + txt + "</div>";

    if (p.image)
      html += "<img src='" + p.image + "'>";

    html += "<br><button onclick='editPost(" + p.id + ")'>Edit</button>";
    html += "<button onclick='deletePost(" + p.id + ")'>Delete</button>";

    div.innerHTML = html;
    box.appendChild(div);
  });
}

// ---------- DELETE ----------
function deletePost(id) {
  let i = posts.findIndex(x => x.id === id);
  if (i >= 0) {
    deleted.unshift(posts.splice(i, 1)[0]);
    saveAll();
    renderPosts(posts);
  }
}

// ---------- RENDER RECYCLE BIN ----------
function renderDeleted() {
  let box = document.getElementById("deletedList");
  box.innerHTML = "";

  deleted.forEach(p => {
    let d = document.createElement("div");
    d.className = "tag";
    d.textContent = p.text.substring(0, 30) + "...";
    box.appendChild(d);
  });
}

// ---------- EDIT ----------
function editPost(id) {
  let p = posts.find(x => x.id === id);
  editID = id;

  document.getElementById("postText").value = p.text;

  if (p.image) {
    let pv = document.getElementById("previewImg");
    pv.src = p.image;
    pv.style.display = "block";
    document.getElementById("imageInput").dataset.pasted = p.image;
  }

  renderPosts(posts);
}

// ---------- FILTER BY HASHTAG ----------
function filterHashtag(tag) {
  renderPosts(posts.filter(p => p.hashtags.includes(tag)));
}

// ---------- LIST TAGS ----------
function renderTags() {
  let all = new Set();
  posts.forEach(p => p.hashtags.forEach(h => all.add(h)));

  let box = document.getElementById("tagList");
  box.innerHTML = "";

  [...all].sort().forEach(t => {
    let d = document.createElement("div");
    d.className = "tag";
    d.textContent = "#" + t;
    d.onclick = () => filterHashtag(t);
    box.appendChild(d);
  });
}

// ---------- SEARCH ----------
document.getElementById("searchInput").addEventListener("input", function() {
  let q = this.value.toLowerCase();
  let filtered = posts.filter(p =>
    p.text.toLowerCase().includes(q) ||
    p.hashtags.some(h => h.toLowerCase().includes(q))
  );
  renderPosts(filtered);
});

// INIT
renderPosts(posts);
renderTags();
renderDeleted();
</script>
</body>
</html>
