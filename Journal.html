<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personal Journal - OneDrive Sync</title>

  <!-- MSAL.js (Microsoft Authentication Library for browser) -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#121212; color:white; }
    #layout { display:flex; max-width:1100px; margin:auto; padding:20px; gap:20px; }
    #app { flex:3; }
    #sidebar { flex:1; background:#1e1e1e; padding:15px; border-radius:8px; height:fit-content; }

    .topbar {
      background:#1e1e1e;
      padding:10px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #333;
    }

    .post-box, .search-box { background:#1e1e1e; padding:15px; border-radius:8px; margin-bottom:20px; }
    .post { background:#1e1e1e; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #333; }
    .post img { max-width:100%; margin-top:10px; border-radius:6px; }

    .hashtag { color:#4da3ff; cursor:pointer; }
    .tag { display:block; margin-bottom:6px; cursor:pointer; color:#4da3ff; }

    input, textarea { background:#2b2b2b; color:white; border:1px solid #444; }
    button {
      background:#333; color:white; border:1px solid #555;
      padding:8px 12px; margin-right:6px; cursor:pointer; border-radius:4px;
    }
    button[disabled] { opacity:0.5; cursor:default; }

    #previewImg {
      max-width:200px; margin-top:10px; border-radius:6px;
      display:none; border:1px solid #444;
    }

    .status { font-size:13px; opacity:0.8; }
  </style>
</head>
<body>

  <div class="topbar">
    <div><strong>Local Journal (OneDrive Sync)</strong></div>
    <div>
      <span id="loginStatus" class="status">Checking sign-in...</span>
      <button id="loginBtn" onclick="signIn()">Sign in with Microsoft</button>
      <button id="logoutBtn" onclick="signOut()" style="display:none;">Sign out</button>
    </div>
  </div>

  <div id="layout">
    <div id="app">

      <div class="search-box">
        <input id="searchInput" type="text" placeholder="Search..." style="width:100%; padding:10px; font-size:16px;" />
      </div>

      <div class="post-box">
        <textarea id="postText" placeholder="Write something..." style="width:100%; height:80px; padding:10px;"></textarea>
        <input id="imageInput" type="file" accept="image/*" style="margin-top:10px;" />
        <img id="previewImg" alt="Image preview" />
        <div style="margin-top:10px;">
          <button id="savePostBtn" onclick="savePost()" disabled>Post</button>
        </div>
        <div class="status" style="margin-top:5px;">Tip: you can paste an image from clipboard into the page.</div>
      </div>

      <div id="posts"></div>

    </div>

    <div id="sidebar">
      <h3>Hashtags</h3>
      <div id="tagList"></div>
    </div>
  </div>

<script>
  /******************************
   * MSAL / AUTH CONFIG
   ******************************/
  const msalConfig = {
    auth: {
      clientId: "dbce75a6-3fb1-4b10-91b5-d21f65151b62",
      authority: "https://login.microsoftonline.com/common", // supports personal + work
      redirectUri: "https://7arahim.github.io/local-journal/"
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: false
    }
  };

  const loginRequest = {
    scopes: ["Files.ReadWrite", "offline_access"]
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  let account = null;
  let accessToken = null;

  /******************************
   * APP STATE
   ******************************/
  let posts = [];
  let editId = null; // when editing a post

  const GRAPH_BASE = "https://graph.microsoft.com/v1.0";
  const JOURNAL_FOLDER_PATH = "/me/drive/root:/local%20journal";
  // Each post is: /local journal/posts/post-<id>.json

  /******************************
   * AUTH FLOW
   ******************************/
  window.onload = () => {
    msalInstance.handleRedirectPromise()
      .then(async (response) => {
        if (response && response.account) {
          account = response.account;
        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            account = accounts[0];
          }
        }

        if (account) {
          setSignedInUI(true, account.username);
          await getToken();
          await loadPostsFromDrive();
        } else {
          setSignedInUI(false);
        }
      })
      .catch(err => {
        console.error(err);
        setSignedInUI(false, "Sign-in error");
      });

    setupUIHandlers();
  };

  function setSignedInUI(isSignedIn, username) {
    const loginStatus = document.getElementById("loginStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const saveBtn = document.getElementById("savePostBtn");

    if (isSignedIn) {
      loginStatus.textContent = "Signed in as " + (username || "");
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      saveBtn.disabled = false;
    } else {
      loginStatus.textContent = "Not signed in";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      saveBtn.disabled = true;
    }
  }

  function signIn() {
    msalInstance.loginRedirect(loginRequest);
  }

  function signOut() {
    const logoutRequest = {
      account: account
    };
    msalInstance.logoutRedirect(logoutRequest);
  }

  async function getToken() {
    if (!account) return;

    const tokenRequest = {
      ...loginRequest,
      account
    };

    try {
      const response = await msalInstance.acquireTokenSilent(tokenRequest);
      accessToken = response.accessToken;
    } catch (e) {
      console.warn("Silent token acquisition failed, redirecting for interactive login", e);
      msalInstance.acquireTokenRedirect(tokenRequest);
    }
  }

  function graphFetch(url, options = {}, addAuth = true) {
    if (addAuth) {
      if (!options.headers) options.headers = {};
      options.headers["Authorization"] = "Bearer " + accessToken;
    }
    return fetch(url, options);
  }

  /******************************
   * GRAPH HELPERS (OneDrive)
   ******************************/

  async function ensureFolderStructure() {
    // Creating a file by path will auto-create folders in many cases,
    // so we rely mostly on that. This function is a no-op placeholder
    // for future enhancements if you want stronger checks.
    return;
  }

  async function loadPostsFromDrive() {
    posts = [];
    try {
      const listUrl = GRAPH_BASE + JOURNAL_FOLDER_PATH + "/posts:/children";
      const res = await graphFetch(listUrl);
      if (!res.ok) {
        // Folder might not exist yet; that's fine (no posts yet)
        console.log("No posts folder yet or error listing:", await res.text());
        renderPosts();
        renderTags();
        return;
      }

      const data = await res.json();
      if (!data.value) {
        renderPosts();
        renderTags();
        return;
      }

      // For each JSON file, fetch content
      for (const item of data.value) {
        if (!item.name.endsWith(".json")) continue;

        // use the downloadUrl so we don't have to add auth header again
        const downloadUrl = item["@microsoft.graph.downloadUrl"];
        const cRes = await fetch(downloadUrl);
        if (!cRes.ok) continue;
        const postJson = await cRes.json();
        if (!postJson.deleted) {
          posts.push(postJson);
        }
      }

      // newest first
      posts.sort((a, b) => b.id - a.id);
      renderPosts();
      renderTags();
    } catch (err) {
      console.error("Error loading posts:", err);
    }
  }

  async function uploadPostToDrive(post) {
    await ensureFolderStructure();
    const fileName = "post-" + post.id + ".json";
    const url = GRAPH_BASE + JOURNAL_FOLDER_PATH + "/posts/" + fileName + ":/content";

    const body = JSON.stringify(post);

    const res = await graphFetch(url, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body
    });

    if (!res.ok) {
      console.error("Error uploading post", await res.text());
    }
  }

  /******************************
   * UI HANDLERS
   ******************************/

  function setupUIHandlers() {
    // search box
    document.getElementById("searchInput").addEventListener("input", function () {
      const q = this.value.toLowerCase();
      const filtered = posts.filter(p =>
        (p.text || "").toLowerCase().includes(q) ||
        (p.hashtags || []).some(h => h.toLowerCase().includes(q))
      );
      renderPosts(filtered);
    });

    // paste image support
    document.addEventListener("paste", event => {
      const items = event.clipboardData.items;
      for (let item of items) {
        if (item.type.indexOf("image") !== -1) {
          const file = item.getAsFile();
          const reader = new FileReader();
          reader.onload = e => {
            const dataUrl = e.target.result;
            const preview = document.getElementById("previewImg");
            preview.src = dataUrl;
            preview.style.display = "block";
            document.getElementById("imageInput").dataset.pasted = dataUrl;
          };
          reader.readAsDataURL(file);
        }
      }
    });
  }

  function extractHashtags(text) {
    const matches = text.match(/#\w+/g);
    return matches ? matches.map(h => h.substring(1)) : [];
  }

  async function savePost() {
    if (!accessToken) {
      alert("Please sign in first.");
      return;
    }

    const text = document.getElementById("postText").value;
    const fileInput = document.getElementById("imageInput");
    const file = fileInput.files[0];
    const pastedImg = fileInput.dataset.pasted || null;

    if (!text.trim() && !file && !pastedImg) return;

    function clearEditor() {
      document.getElementById("postText").value = "";
      fileInput.value = "";
      delete fileInput.dataset.pasted;
      const preview = document.getElementById("previewImg");
      preview.style.display = "none";
      preview.src = "";
      editId = null;
    }

    function createOrUpdatePost(imageDataUrl) {
      const now = new Date().toLocaleString();

      if (editId) {
        // update existing
        const p = posts.find(x => x.id === editId);
        if (!p) return;
        p.text = text;
        p.imageDataUrl = imageDataUrl || null;
        p.hashtags = extractHashtags(text);
        // keep original created_at
      } else {
        const newPost = {
          id: Date.now(),
          text,
          imageDataUrl: imageDataUrl || null,
          hashtags: extractHashtags(text),
          created_at: now,
          deleted: false
        };
        posts.unshift(newPost);
      }

      return imageDataUrl;
    }

    async function finish(imageDataUrl) {
      createOrUpdatePost(imageDataUrl);
      // upload whichever post we just changed
      const postToSave = editId
        ? posts.find(p => p.id === editId)
        : posts[0];

      await uploadPostToDrive(postToSave);
      renderPosts();
      renderTags();
      clearEditor();
    }

    if (file) {
      const reader = new FileReader();
      reader.onload = async e => {
        const dataUrl = e.target.result;
        await finish(dataUrl);
      };
      reader.readAsDataURL(file);
    } else {
      await finish(pastedImg || null);
    }
  }

  function renderPosts(listOpt) {
    const list = listOpt || posts;
    const container = document.getElementById("posts");
    container.innerHTML = "";

    list.forEach(p => {
      const div = document.createElement("div");
      div.className = "post";

      let textHTML = (p.text || "").replace(
        /#(\w+)/g,
        "<span class='hashtag' onclick='filterHashtag(\"$1\")'>#$1</span>"
      );

      let html = "";
      html += "<div style='opacity:0.6; font-size:12px; margin-bottom:6px;'>" +
              (p.created_at || "") + "</div>";
      html += "<div>" + textHTML + "</div>";

      if (p.imageDataUrl) {
        html += "<img src='" + p.imageDataUrl + "' alt='Post image'>";
      }

      html += "<br>";
      html += "<button onclick='editPost(" + p.id + ")'>Edit</button>";
      html += "<button onclick='deletePost(" + p.id + ")'>Delete</button>";

      div.innerHTML = html;
      container.appendChild(div);
    });
  }

  function renderTags() {
    const all = new Set();
    posts.forEach(p => (p.hashtags || []).forEach(h => all.add(h)));

    const tagList = document.getElementById("tagList");
    tagList.innerHTML = "";

    Array.from(all).sort().forEach(tag => {
      const div = document.createElement("div");
      div.className = "tag";
      div.textContent = "#" + tag;
      div.onclick = () => filterHashtag(tag);
      tagList.appendChild(div);
    });
  }

  function filterHashtag(tag) {
    const filtered = posts.filter(p => (p.hashtags || []).includes(tag));
    renderPosts(filtered);
  }

  function editPost(id) {
    const p = posts.find(x => x.id === id);
    if (!p) return;
    editId = id;

    document.getElementById("postText").value = p.text || "";

    if (p.imageDataUrl) {
      const preview = document.getElementById("previewImg");
      preview.src = p.imageDataUrl;
      preview.style.display = "block";
      document.getElementById("imageInput").dataset.pasted = p.imageDataUrl;
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  async function deletePost(id) {
    const idx = posts.findIndex(p => p.id === id);
    if (idx === -1) return;

    // soft delete flag in the JSON stored in OneDrive
    posts[idx].deleted = true;
    await uploadPostToDrive(posts[idx]);

    posts.splice(idx, 1);
    renderPosts();
    renderTags();
  }
</script>

</body>
</html>
